---
title: 
author:
output:
  pdf_document: 
    number_sections: true
    extra_dependencies: ["polski", "mathtools", "amsthm", "amssymb", "icomma", "upgreek", "xfrac", "scrextend", "float", "tabularx", "hyperref", "caption", "enumitem", "titlesec"]
fontsize: 12pt
---


\renewcommand{\figurename}{Wykres}
\renewcommand{\tablename}{Tablica}
\raggedbottom
\titlelabel{\thetitle.\quad}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE, fig.pos = "H", dev.args=list(encoding="CP1257.enc"))
library(reticulate)
path <- readLines("python_path.txt")
use_python(path)
```


```{python}
from sqlalchemy import create_engine, MetaData, Table, text
from sqlalchemy.orm import sessionmaker
from urllib.parse import quote

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import scipy.stats as sp
from datetime import datetime

import warnings
warnings.filterwarnings('ignore')

today = str(datetime.today().date())

username = 'team25'
password = quote('te@mzs')
database = 'team25'
host = 'giniewicz.it'
port = '3306'

engine = create_engine(f'mysql+pymysql://{username}:{password}@{host}:{port}/{database}')

metadata = MetaData()
games_for_sale = Table('games_for_sale', metadata, autoload_with = engine)
games_to_rent = Table('games_to_rent', metadata, autoload_with = engine)
customers = Table('customers', metadata, autoload_with = engine)
staff = Table('staff', metadata, autoload_with = engine)
sale = Table('sale', metadata, autoload_with = engine)
rental = Table('rental', metadata, autoload_with = engine)
competition = Table('competition', metadata, autoload_with = engine)
competition_results = Table('competition_results', metadata, autoload_with = engine)

connection = engine.connect()
```






\title{ \Large \textsc{Bazy danych}
		\\ [5.5cm]
		\LARGE \textbf{\uppercase{Analiza danych i raport}}
		%\\ [0.5cm]
		%\normalsize \today \vspace*{20\baselineskip}
		}
	\date{}
	\maketitle
	\vspace{7cm}
	
\begin{center}
\author{
  Szymon Malec, 262276 \\
  Adam Wrzesiński, 262317\\
  Michał Wiktorowski, 262330 \\
  Weronika Zmyślona, 262284 \\
  \vspace{0.5cm}
  Politechnika Wrocławska \\
  Wydział Matematyki - Matematyka Stosowana}
\end{center}

\thispagestyle{empty}

\newpage\thispagestyle{empty}
\mbox{}

\setcounter {page}{1}

\tableofcontents

\newpage





\section{Wstęp}

|       Raport pełni funkcję podsumowującą dane dostepne w bazie sklepu Geeks and Dragons za pomocą wizualizacji i podstawowych statystyk. W dalszej części znajdują się rozwiązania nastepujących zagadnień i pytań:
\begin{itemize}
  \item Ranking na pracownika miesiąca.
  \item Ranking zawodników turniejowych.
  \item Które gry przynoszą największy dochód ze sprzedaży, a które z wypożyczeń?
  \item Które kategorie są najpopularniejsze?
  \item Jak zmieniała się sprzedaż na przestrzeni lat?
  \item Czy ocena gry i cena wpływają na sprzedaż?
  \item Ile gier dostępne jest w sklepie?
\end{itemize}
Dodatkowo raport ma postać uniwersalną, co oznacza, że przy odświeżeniu dostosowuje się on do zmian w danych i prezentuje aktualne wykresy i wyniki. Ostatnia data kompilacji: `r I(py$today)`.




\section{Ranking na pracownika miesiąca}

|       Ranking na pracownika miesiąca wyznaczony został na podstawie liczby sprzedanych przez pracownika egzemplarzy w danym miesiącu. Kwoty sprzedaży oraz wypożyczenia nie były brane pod uwagę. Poniżej możemy zobaczyć jak prezentował się ranking pracowników w każdym z ostatnich 6 miesięcy.

W ostatnim miesiącu pierwsze miejsce w rankingu zajął/zajęła ...




\section{Ranking zawodników turniejowych}

|       Ranking zawodników turniejów organizowanych przez sklep wyznaczany jest na podstawie miejsc, które uczestnik zajął we wszystkich zawodach organizowanych do tej pory. Dla danego zawodnika brane są pod uwagę tylko miejsca na podium. 1. miejsce daje 3 punkty, 2. miejsce 2 punkty, natomiast 3. daje 1 punkt. Wynikiem, na bazie którego kształtuje się ranking, jest suma punktów uzyskanych ze wszystkich dotychczasowych turniejów.




\section{Które gry przynoszą największy dochód ze sprzedaży, a które z wypożyczeń?}

|       Na podstawie sumarycznych dochodów ze sprzedaży jakie wygenerowała każda gra w ostatnim miesiącu, został wyznaczony ranking najbardziej dochodowych gier.

Podobnie tworzymy ranking dla dochodów z wypożyczeń.




\section{Które kategorie są najpopularniejsze?}

|       Aby odpowiedzić na to pytanie, zliczamy ile gier z danej kategorii sprzedało się od początku historii sklepu. Na tej podstawie tworzymy ranking kategorii, do której gry należące są najczęściej kupowane.

To samo robimy, by wyznaczyć ranking najczęsciej wypożyczanych gier, z tym że tutaj zliczamy wypożyczenia.




\section{Jak zmieniała się sprzedaż na przestrzeni lat?}

|       Tak jak widać na wykresie poniżej.




\section{Czy ocena gry i cena wpływają na sprzedaż?}

|       Aby ocenić zeleżność pomiędzy średnią oceną gry, a liczbą sprzedanych sztuk, możemy spojrzeć na wykres punktowy.

```{python rating_scatter, fig.cap="\\label{fig:rating_scatter} Wykres punktowy sprzedanych sztuk danej gry w zależności od jej średniej oceny.", fig.align="center", fig.width = 8, fig.height = 5}
sql = """
select s.game_id, g.name, g.avg_rating, g.price, count(*) as sale_count
from sale s
join games_for_sale g
  on s.game_id = g.game_id
where s.date > date_add(sysdate(), interval -12 month)
group by s.game_id, g.name, g.avg_rating, g.price
order by sale_count desc
"""
result = connection.execute(text(sql))
game_sale = pd.DataFrame(result.fetchall(), columns=result.keys())

cor_pearson = round(np.corrcoef(game_sale.avg_rating, game_sale.sale_count)[0, 1], 2)
cor_spearman = round(sp.spearmanr(game_sale.avg_rating, game_sale.sale_count)[0], 2)

plt.figure(figsize=(14, 8))
plt.scatter(game_sale.avg_rating, game_sale.sale_count)
plt.xlabel('Średnia ocena gry')
plt.ylabel('Liczba sprzedanych sztuk')
plt.show()
```

Współczynnik korelacji Pearsona wyniósł `r I(py$cor_pearson)`, natomiast współczynnik Spearmana jest równy `r I(py$cor_spearman)`.


Następnie dokładnie to samo wykonujemy dla ceny gry, aby ocenić, czy cena wpływa na sprzedaż.

```{python price_scatter, fig.cap="\\label{fig:price_scatter} Wykres punktowy sprzedanych sztuk danej gry w zależności od jej ceny.", fig.align="center", fig.width = 8, fig.height = 5}
cor_pearson = round(np.corrcoef(game_sale.price, game_sale.sale_count)[0, 1], 2)
cor_spearman = round(sp.spearmanr(game_sale.price, game_sale.sale_count)[0], 2)

plt.figure(figsize=(14, 8))
plt.scatter(game_sale.price, game_sale.sale_count)
plt.xlabel('Cena gry')
plt.ylabel('Liczba sprzedanych sztuk')
plt.show()
```

Współczynnik korelacji Pearsona wyniósł `r I(py$cor_pearson)`, natomiast współczynnik Spearmana jest równy `r I(py$cor_spearman)`.




\section{Ile gier dostępne jest w sklepie?}





```{python}
connection.close()
```
